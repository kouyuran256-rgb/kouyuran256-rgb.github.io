<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>åŒ¿åéšæœº P2P èŠå¤©</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; max-width: 600px; margin: 50px auto; background: #f4f4f9; }
  h1 { text-align: center; color: #333; }
  #startBtn { display: block; margin: 20px auto; padding: 10px 20px; background: #4f46e5; color: white; border: none; border-radius: 10px; cursor: pointer; }
  #chatBox { border: 1px solid #ccc; border-radius: 10px; padding: 10px; height: 400px; overflow-y: auto; background: white; }
  .message { display: flex; margin: 5px 0; align-items: flex-end; }
  .message.me { justify-content: flex-end; }
  .message .avatar { width: 30px; height: 30px; border-radius: 50%; background: #ccc; display: inline-block; margin: 0 5px; }
  .message .bubble { max-width: 70%; padding: 8px 12px; border-radius: 15px; background: #e0e0e0; }
  .message.me .bubble { background: #4f46e5; color: white; }
  #inputContainer { display: flex; margin-top: 10px; }
  #messageInput { flex: 1; padding: 8px; border-radius: 10px; border: 1px solid #ccc; }
  #sendBtn { padding: 8px 15px; margin-left: 10px; border-radius: 10px; border: none; background: #4f46e5; color: white; cursor: pointer; }
</style>
</head>
<body>
<h1>åŒ¿åéšæœº P2P èŠå¤©</h1>

<button id="startBtn">å¼€å§‹éšæœºèŠå¤©</button>

<div id="chatBox"></div>

<div id="inputContainer">
  <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯" disabled>
  <button id="sendBtn" disabled>å‘é€</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
import Peer from "https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics.js";

// ğŸ”‘ Firebase é…ç½®
const firebaseConfig = {
  apiKey: "AIzaSyAC9HWZx10dKzI1vy9gm5gWODmBYrdGUlM",
  authDomain: "us256-33f2c.firebaseapp.com",
  projectId: "us256-33f2c",
  storageBucket: "us256-33f2c.firebasestorage.app",
  messagingSenderId: "456338392274",
  appId: "1:456338392274:web:74ee8577be6625b778990b",
  measurementId: "G-F286QQYRY6"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getFirestore(app);
const waitingUsersCol = collection(db, "waitingUsers");

// PeerJS
let myPeer = new Peer(undefined, { host: '0.peerjs.com', port: 443, path: '/' });
let conn;

const chatBox = document.getElementById('chatBox');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const startBtn = document.getElementById('startBtn');

// éšæœºé¢œè‰²å¤´åƒ
function randomColor() {
  const colors = ['#F87171','#FBBF24','#34D399','#60A5FA','#A78BFA','#F472B6'];
  return colors[Math.floor(Math.random() * colors.length)];
}

// æ˜¾ç¤ºæ¶ˆæ¯
function appendMessage(msg, isMe=false){
  const div = document.createElement('div');
  div.classList.add('message');
  if(isMe) div.classList.add('me');

  const avatar = document.createElement('div');
  avatar.className = 'avatar';
  avatar.style.background = randomColor();

  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = msg;

  if(isMe){
    div.appendChild(bubble);
    div.appendChild(avatar);
  } else {
    div.appendChild(avatar);
    div.appendChild(bubble);
  }

  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// å‘é€æ¶ˆæ¯
sendBtn.onclick = () => {
  const msg = messageInput.value;
  if(!msg || !conn || conn.open === false) return;
  conn.send(msg);
  appendMessage(msg, true);
  messageInput.value = '';
}

// å¼€å§‹éšæœºèŠå¤©
startBtn.onclick = async () => {
  startBtn.disabled = true;
  appendMessage("ğŸ”¹ ç­‰å¾…éšæœºåŒ¹é…...");

  myPeer.on('open', async id => {
    const myDoc = await addDoc(waitingUsersCol, { peerId: id });

    onSnapshot(waitingUsersCol, snapshot => {
      snapshot.docChanges().forEach(async change => {
        if(change.type === "added" && change.doc.id !== myDoc.id){
          const otherPeerId = change.doc.data().peerId;
          appendMessage("ğŸ”¹ åŒ¹é…åˆ°å¯¹æ–¹ï¼Œå»ºç«‹ P2P è¿æ¥...");
          conn = myPeer.connect(otherPeerId);

          conn.on('open', () => {
            appendMessage("âœ… å·²è¿æ¥å¯¹æ–¹ï¼Œå¯ä»¥èŠå¤©äº†ï¼");
            messageInput.disabled = false;
            sendBtn.disabled = false;
          });

          conn.on('data', data => appendMessage(data, false));

          // ä»ç­‰å¾…æ± ç§»é™¤åŒæ–¹
          deleteDoc(doc(db, "waitingUsers", change.doc.id));
          deleteDoc(doc(db, "waitingUsers", myDoc.id));
        }
      });
    });
  });

  myPeer.on('connection', c => {
    conn = c;
    conn.on('open', () => {
      appendMessage("âœ… å¯¹æ–¹å·²è¿æ¥ï¼Œå¯ä»¥èŠå¤©äº†ï¼");
      messageInput.disabled = false;
      sendBtn.disabled = false;
    });
    conn.on('data', data => appendMessage(data, false));
  });
}
</script>
</body>
</html>
