<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Circle + Anon P2P Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* Base styles */
body { font-family: 'Inter', system-ui, sans-serif; background:#f4f4f9; margin:0; padding:0; }
.container { max-width: 720px; margin:40px auto; padding:0 16px; }
h1 { text-align:center; color:#333; margin-bottom:10px; }
.tab-btns { display:flex; justify-content:center; margin-bottom:20px; }
.tab-btns button { margin:0 10px; padding:10px 20px; border:none; border-radius:25px; cursor:pointer; background:#e5e7eb; font-weight:600; transition:0.2s; }
.tab-btns button.active { background:#4f46e5; color:white; }
.tab-content { display:none; }
.tab-content.active { display:block; }

/* Forum styles */
.subtitle { text-align:center; color:#6b7280; margin-bottom:30px; }
.card { background:#fff; border-radius:16px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,0.04); margin-bottom:24px; }
.post { padding:16px 0; border-bottom:1px solid #e5e7eb; }
.post:last-child { border-bottom:none; }
.post-body { font-size:15px; color:#374151; }
.ai { margin-top:12px; font-size:14px; color:#6b7280; font-style:italic; }
textarea { width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:12px; font-size:15px; resize:vertical; min-height:80px; }
button.post-btn { margin-top:12px; background:#2563eb; color:white; border:none; border-radius:999px; padding:10px 20px; font-size:14px; cursor:pointer; }
.note { font-size:14px; color:#6b7280; margin-top:12px; }
footer { text-align:center; font-size:14px; color:#9ca3af; margin-top:48px; }
footer a { color:#6b7280; text-decoration:none; margin:0 8px; }

/* P2P Chat styles */
#chatBox { background:white; border-radius:15px; padding:16px; height:400px; overflow-y:auto; border:1px solid #ddd; margin-bottom:12px; }
.message { display:flex; align-items:flex-end; margin:6px 0; }
.message.me { justify-content:flex-end; }
.message .avatar { width:30px; height:30px; border-radius:50%; background:#ccc; margin:0 8px; }
.message .bubble { max-width:70%; padding:8px 14px; border-radius:15px; background:#e5e7eb; font-size:14px; word-wrap:break-word; }
.message.me .bubble { background:#4f46e5; color:white; }
#inputContainer { display:flex; margin-bottom:40px; }
#messageInput { flex:1; padding:10px; border-radius:25px; border:1px solid #ccc; font-size:14px; }
#sendBtn { padding:10px 20px; margin-left:10px; border-radius:25px; border:none; background:#4f46e5; color:white; font-size:14px; cursor:pointer; }
</style>
</head>
<body>

<div class="container">
<h1>Circle + Random Chat</h1>
<div class="tab-btns">
  <button id="forumTabBtn" class="active">Forum</button>
  <button id="chatTabBtn">Random Chat</button>
</div>

<!-- Forum -->
<div id="forumTab" class="tab-content active">
  <p class="subtitle">A calm public forum with reflective AI presence.</p>
  <div class="card" id="board">
    <div class="post">
      <div class="post-body">I keep thinking I should be doing more with my life.</div>
      <div class="ai">Circle: You said ‚Äúshould‚Äù very softly. That usually means you‚Äôre already tired.</div>
    </div>
  </div>
  <div class="card">
    <strong>Post something</strong>
    <p class="note">This is a local demo. Posts are not stored. AI responses are reflective, not advice.</p>
    <textarea id="input" placeholder="Say something you usually keep to yourself..."></textarea>
    <button class="post-btn" onclick="post()">Post</button>
    <p class="note">Illegal content, harassment, scams, or adult material are prohibited.</p>
  </div>
</div>

<!-- Random Chat -->
<div id="chatTab" class="tab-content">
  <p class="subtitle">Click start to be randomly paired. Messages disappear on refresh.</p>
  <button id="startBtn">Start Chat</button>
  <div id="chatBox"></div>
  <div id="inputContainer">
    <input type="text" id="messageInput" placeholder="Type a message..." disabled>
    <button id="sendBtn" disabled>Send</button>
  </div>
</div>

<footer>
  <p>This website is NOT a dating service and does NOT provide matchmaking.</p>
  <p>
    <a href="privacy.html">Privacy</a> ¬∑
    <a href="rules.html">Community Rules</a>
  </p>
  ¬© Circle
</footer>
</div>

<script type="module">
// --------------------- Forum JS ---------------------
const AI_NAME="Honey";
const responses=[
  "You didn‚Äôt rush that sentence. That tells me it matters more than you‚Äôre admitting.",
  "You explained it calmly, but the feeling underneath doesn‚Äôt sound calm.",
  "Most people would have stopped typing earlier. You didn‚Äôt.",
  "You‚Äôre not looking for an answer. You‚Äôre checking if it‚Äôs safe to say this.",
  "That thought usually appears when someone has been holding themselves together for too long.",
  "You chose those words carefully. Almost like you didn‚Äôt want to scare yourself.",
  "There‚Äôs something unfinished in what you wrote. I can feel the pause."
];
function post(){
  const text=document.getElementById("input").value.trim();
  if(!text) return;
  const board=document.getElementById("board");
  const postDiv=document.createElement("div");
  postDiv.className="post";
  const body=document.createElement("div");
  body.className="post-body";
  body.textContent=text;
  const ai=document.createElement("div");
  ai.className="ai";
  ai.textContent="Circle is thinking‚Ä¶";
  postDiv.appendChild(body);
  postDiv.appendChild(ai);
  board.appendChild(postDiv);
  document.getElementById("input").value="";
  setTimeout(()=>{
    const r=responses[Math.floor(Math.random()*responses.length)];
    ai.textContent=AI_NAME+": "+r;
  },900);
}

// --------------------- Tab Switching ---------------------
const forumTabBtn=document.getElementById('forumTabBtn');
const chatTabBtn=document.getElementById('chatTabBtn');
const forumTab=document.getElementById('forumTab');
const chatTab=document.getElementById('chatTab');
forumTabBtn.onclick=()=>{
  forumTabBtn.classList.add('active'); chatTabBtn.classList.remove('active');
  forumTab.classList.add('active'); chatTab.classList.remove('active');
};
chatTabBtn.onclick=()=>{
  chatTabBtn.classList.add('active'); forumTabBtn.classList.remove('active');
  chatTab.classList.add('active'); forumTab.classList.remove('active');
};

// --------------------- Random Chat JS ---------------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
import Peer from "https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js";

const firebaseConfig = {
  apiKey: "AIzaSyAC9HWZx10dKzI1vy9gm5gWODmBYrdGUlM",
  authDomain: "us256-33f2c.firebaseapp.com",
  projectId: "us256-33f2c",
  storageBucket: "us256-33f2c.firebasestorage.app",
  messagingSenderId: "456338392274",
  appId: "1:456338392274:web:74ee8577be6625b778990b",
  measurementId: "G-F286QQYRY6"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const waitingUsersCol = collection(db, "waitingUsers");

let myPeer=new Peer(undefined,{host:'0.peerjs.com',port:443,path:'/'});
let conn;

const chatInput=document.getElementById('messageInput');
const sendButton=document.getElementById('sendBtn');
const startButton=document.getElementById('startBtn');
const chatBoxEl=document.getElementById('chatBox');

function randomColor(){const colors=['#F87171','#FBBF24','#34D399','#60A5FA','#A78BFA','#F472B6'];return colors[Math.floor(Math.random()*colors.length)];}
function appendMessage(msg,isMe=false){const div=document.createElement('div');div.classList.add('message');if(isMe) div.classList.add('me');const avatar=document.createElement('div');avatar.className='avatar';avatar.style.background=randomColor();const bubble=document.createElement('div');bubble.className='bubble';bubble.textContent=msg;if(isMe){div.appendChild(bubble);div.appendChild(avatar);}else{div.appendChild(avatar);div.appendChild(bubble);}chatBoxEl.appendChild(div);chatBoxEl.scrollTop=chatBoxEl.scrollHeight;}
sendButton.onclick=()=>{const msg=chatInput.value.trim();if(!msg||!conn||conn.open===false) return;conn.send(msg);appendMessage(msg,true);chatInput.value='';}
startButton.onclick=async()=>{
  startButton.disabled=true;appendMessage("üîπ Waiting for a random stranger...");
  myPeer.on('open',async id=>{
    const myDoc=await addDoc(waitingUsersCol,{peerId:id});
    onSnapshot(waitingUsersCol,snapshot=>{
      snapshot.docChanges().forEach(async change=>{
        if(change.type==="added"&&change.doc.id!==myDoc.id){
          const otherPeerId=change.doc.data().peerId;
          appendMessage("üîπ Stranger found. Connecting...");
          conn=myPeer.connect(otherPeerId);
          conn.on('open',()=>{appendMessage("‚úÖ Connection established. Start chatting!");chatInput.disabled=false;sendButton.disabled=false;});
          conn.on('data',data=>appendMessage(data,false));
          deleteDoc(doc(db,"waitingUsers",change.doc.id));
          deleteDoc(doc(db,"waitingUsers",myDoc.id));
        }
      });
    });
  });
  myPeer.on('connection',c=>{conn=c;conn.on('open',()=>{appendMessage("‚úÖ Stranger connected. Start chatting!");chatInput.disabled=false;sendButton.disabled=false;});conn.on('data',data=>appendMessage(data,false));});
}
</script>
</body>
</html>
