<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>åŒ¿åéšæœº P2P èŠå¤©</title>
<style>
  body { font-family: sans-serif; max-width: 600px; margin: 50px auto; }
  #chatBox { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; margin-bottom: 10px; }
  #messageInput { width: 80%; padding: 5px; }
  #sendBtn { padding: 5px 10px; }
  #startBtn { padding: 10px 20px; margin-bottom: 10px; }
</style>
</head>
<body>
<h1>åŒ¿åéšæœº P2P èŠå¤©</h1>

<button id="startBtn">å¼€å§‹éšæœºèŠå¤©</button>

<div id="chatBox"></div>

<input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯" disabled>
<button id="sendBtn" disabled>å‘é€</button>

<script type="module">
  // Firebase SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics.js";

  // ğŸ”‘ ä½ çš„ Firebase é…ç½®
  const firebaseConfig = {
    apiKey: "AIzaSyAC9HWZx10dKzI1vy9gm5gWODmBYrdGUlM",
    authDomain: "us256-33f2c.firebaseapp.com",
    projectId: "us256-33f2c",
    storageBucket: "us256-33f2c.firebasestorage.app",
    messagingSenderId: "456338392274",
    appId: "1:456338392274:web:74ee8577be6625b778990b",
    measurementId: "G-F286QQYRY6"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);
  const waitingUsersCol = collection(db, "waitingUsers");

  // PeerJS
  import Peer from "https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js";

  let myPeer = new Peer(undefined, {
    host: '0.peerjs.com',
    port: 443,
    path: '/'
  });
  let conn;

  const chatBox = document.getElementById('chatBox');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const startBtn = document.getElementById('startBtn');

  function appendMessage(msg){
    const div = document.createElement('div');
    div.textContent = msg;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // å‘é€æ¶ˆæ¯
  sendBtn.onclick = () => {
    const msg = messageInput.value;
    if (!msg || !conn || conn.open === false) return;
    conn.send(msg);
    appendMessage("æˆ‘: " + msg);
    messageInput.value = '';
  }

  // å¼€å§‹éšæœºèŠå¤©
  startBtn.onclick = async () => {
    startBtn.disabled = true;
    appendMessage("ğŸ”¹ ç­‰å¾…éšæœºåŒ¹é…...");

    myPeer.on('open', async id => {
      // åŠ å…¥ Firebase ç­‰å¾…æ± 
      const myDoc = await addDoc(waitingUsersCol, { peerId: id });

      // ç›‘å¬æ•°æ®åº“å˜åŒ–åŒ¹é…å…¶ä»–ç”¨æˆ·
      onSnapshot(waitingUsersCol, snapshot => {
        snapshot.docChanges().forEach(async change => {
          if(change.type === "added" && change.doc.id !== myDoc.id){
            const otherPeerId = change.doc.data().peerId;
            appendMessage("ğŸ”¹ åŒ¹é…åˆ°å¯¹æ–¹ï¼Œå»ºç«‹ P2P è¿æ¥...");
            conn = myPeer.connect(otherPeerId);

            conn.on('open', () => {
              appendMessage("âœ… å·²è¿æ¥å¯¹æ–¹ï¼Œå¯ä»¥èŠå¤©äº†ï¼");
              messageInput.disabled = false;
              sendBtn.disabled = false;
            });

            conn.on('data', data => appendMessage("å¯¹æ–¹: " + data));

            // ä»ç­‰å¾…æ± ç§»é™¤åŒæ–¹
            deleteDoc(doc(db, "waitingUsers", change.doc.id));
            deleteDoc(doc(db, "waitingUsers", myDoc.id));
          }
        });
      });
    });

    // è¢«åŠ¨æ¥æ”¶è¿æ¥
    myPeer.on('connection', c => {
      conn = c;
      conn.on('open', () => {
        appendMessage("âœ… å¯¹æ–¹å·²è¿æ¥ï¼Œå¯ä»¥èŠå¤©äº†ï¼");
        messageInput.disabled = false;
        sendBtn.disabled = false;
      });
      conn.on('data', data => appendMessage("å¯¹æ–¹: " + data));
    });
  }
</script>
</body>
</html>
